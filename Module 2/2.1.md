# Integrating with Lambda Destinations: Enhancing Message Handling

![Lamda Destinations](/assets/lambda-destinations.png)

In the Cloudtopia Passport Office Automation Project, we will explore using Lambda Destinations for managing message delivery. Instead of 
manually writing code to handle SNS publishMessage API and managing error cases, Lambda Destinations allows AWS to handle message delivery 
and retries, simplifying our workflow.

Lambda Destinations is ideal for asynchronous event sources, such as S3 to Lambda, making it suitable for our project. However, it's 
important to note that other integrations, like SQS, are not asynchronous and thus cannot utilize this feature. With Lambda Destinations, 
you can configure it to deliver messages to specified targets upon success or failure, based on the Lambda function's response. This setup 
allows for multiple success and failure destinations, providing flexibility and reliability in managing message flows.

### Step 1: Create ValidationResult SNS Topic

1. **Go to SNS (Simple Notification Service):**  
   - Navigate to the **Topics** section and click **Create topic**.  
   - Choose **Standard** as the type and enter the **Name** `"ValidationResult"`.  
   - Click **Create topic**.

   ![Create Topic](/assets/create-topic.png)

2. **Create a Subscription (to test it out):**  
   - Click **Create subscription** on the new topic.  
   - In the **Protocol** dropdown, select **Email-JSON**, and enter your email address in **Endpoint**.  
   - Click **Create subscription**.  

   ![Create Subscription](/assets/create-subscription.png)

3. **Confirm the Subscription:**  
   - Go to **Subscriptions**, and you should see the new subscription in a **Pending** state.  
   - Check your email for the confirmation link and click it to confirm.  
   - Refresh the **Subscriptions** page to verify the status has changed to **Confirmed**.

   ![Pending](/assets/pending.png)

4. **Test the SNS Topic:**  
   - Click on the **ValidationResult** topic, then select **Publish message**.  
   - Enter a subject (e.g., `"Test"`) and some sample JSON in the **Message body**.  
   - Click **Publish message**.  
   - Check your email for the notification to confirm the topic is working correctly.

   ![Publish Message](/assets/publish-message.png)
   

### Step 2: Attach IAM Policy SNS:Publish to PhotoValidationProcessor

1. **Update the Execution Role in Lambda:**  
   - Go to your **PhotoValidationProcessor** function in the Lambda console.  
   - Click on the **Configuration** tab.  
   - Select **Execution role** under **Permissions** to view and modify the IAM role.  

   ![Photo Validation](/assets/photo-validation.png)

2. **Create an Inline Policy:**  
   - Click **Add permissions** and select **Create inline policy** from the dropdown.  
   - In the **Select a service** dropdown, choose **SNS**.  
   - Under **Write**, check the **Publish** box.  

   ![Inline Policy](/assets/inline-write.png)

3. **Restrict to the Correct Topic:**  
   - Scroll down to **Resources** and click **Add ARN**.  
   - Add the region and the name of your **ValidationResult** topic.  
   - Click **Add ARNs**, then **Review policy**.  
   - Give the policy a name and click **Create policy**.  

   ![Add ARN](/assets/add-arn.png)

4. **Update the Code to Return a Response for Destinations:**  
   - Go back to the **PhotoValidationProcessor** function’s **Code** tab.  
   - After evaluating the face details, add the following snippet to return a JSON object:

     ```python
     # Step 6 - Pipe result using Lambda Destinations
     publish_object = {
         'FileName': current_file_name,
         'ValidationResult': face_evaluation_result['result'],
         'FailureReasons': json.dumps(face_evaluation_result['failure_reasons']),
         'FileLocation': BUCKET_NAME + "/" + current_file_name,
     }
     return {
         'statusCode': 200,
         'body': json.dumps(publish_object)
     }
     ```

   - Click **Deploy**.

5. **Add a Destination for Successful Invocations:**  
   - Scroll up and click **Add destination** in the Lambda function overview.  
   - Under **Source**, select **Asynchronous invocation**, and under **Condition**, select **On success**.  
   - In **Destination type**, choose **SNS topic**, and then select the **ValidationResult** ARN under **Destination**.  
   - Click **Save**.  

   You will now see an **Amazon SNS** entry in the **Function overview**, indicating that the Lambda Destinations configuration is in place.

   ![Lambda SNS](/assets/lambda-sns.png)  
   ![Function Overview](/assets/function-overview.png)


### Step 3: Modify PhotoValidationProcessor to Return a Valid HTTP Response

1. **Trigger the Function via S3:**  
   - Go to your S3 bucket and upload a test image, for example `me_eyes_closed.png`.  
   - This photo should fail validation, triggering the Lambda function and sending a notification to the SNS topic.

2. **Check the Email Notification:**  
   - The email will display the `responsePayload`, which includes `statusCode`, `body`, and detailed evaluation results such as `FileName`, `ValidationResult`, `FailureReasons`, and `FileLocation`.  
   - This confirms that Lambda Destinations is successfully publishing your function’s results to SNS whenever a validation process completes.

   Example snippet from the payload:
   ```json
   "responsePayload": {
       "statusCode": 200,
       "body": "{\"FileName\": \"me_eyes_closed.png\", \"ValidationResult\": \"FAIL\", \"FailureReasons\": \"[\\\"EyesOpen\\\"]\", \"FileLocation\": \"cloudtopia-images-jun-2024/me_eyes_closed.png\"}"
   }
   ```

### Conclusion

In this module, we created an SNS topic named **ValidationResult** and granted our **PhotoValidationProcessor** Lambda function the necessary permissions to publish messages to it. We then leveraged **Lambda Destinations** to automatically direct successful or failed validation results from the Lambda function to the SNS topic, removing the need to manually manage message delivery and retries. By uploading a test image, we confirmed that the function executes, evaluates the image, and publishes the outcome to our email via SNS. This design provides a robust, asynchronous workflow, ensuring that users or downstream processes are immediately notified of the status of each passport photo evaluation.
